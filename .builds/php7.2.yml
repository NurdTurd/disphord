image: debian/buster
artifacts:
  - /home/build/disphord/builds/disphord
tasks:
- setup: |
    sudo apt-get update -y > /dev/null
    sudo apt-get upgrade -y > /dev/null
    sudo apt-get install -y wget lsb-release apt-transport-https ca-certificates zip unzip > /dev/null
    sudo wget -qO /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg
    echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/php.list
    sudo apt-get update > /dev/null
    sudo apt-get purge -y apache2 > /dev/null
    sudo apt-get install -y php7.2 php7.2-{bcmath,bz2,intl,gd,mbstring,mysql,zip,curl,xml} > /dev/null
    sudo apt-get autoremove -y > /dev/null
    sudo apt-get upgrade -y > /dev/null
    wget https://raw.githubusercontent.com/composer/getcomposer.org/master/web/installer -O - -q | sudo php -- --install-dir=/usr/local/bin --filename=composer
    cd disphord
    composer install --no-progress
- test: |
    cd disphord
    set +x
    export WEBHOOK_URL="$(<~/.webhook_url)"
    set -x
    php disphord test
- build: |
    cd disphord
    php disphord app:build --no-ansi -n --build-version="$(git rev-parse --short HEAD)"
- test-webhook: |
    cd disphord
    set +x
    export WEBHOOK_URL="$(<~/.webhook_url)"
    set -x
    ./.builds/run-tests.sh
secrets:
    - 08e8ae4c-f696-4b80-bd2f-7c46f1141539
    - 4e9e3aff-bb8d-4581-891d-9f503bddcad0
